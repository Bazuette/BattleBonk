package libayon.module.modules.exploit;

import libayon.BattleBonk;
import libayon.event.events.client.UpdateEvent;
import libayon.event.events.packets.PacketSentEvent;
import libayon.event.events.player.PreMotionEvent;
import libayon.module.Category;
import libayon.module.Mode;
import libayon.module.Module;
import net.minecraft.network.NetHandlerPlayServer;
import net.minecraft.network.Packet;
import net.minecraft.network.handshake.client.C00Handshake;
import net.minecraft.network.login.client.C00PacketLoginStart;
import net.minecraft.network.status.client.C00PacketServerQuery;

import java.util.LinkedList;

public class PacketDelayer extends Module {
    private final BattleBonk bb = BattleBonk.instance;
    public LinkedList<Packet<NetHandlerPlayServer>> packets = new LinkedList<>();

    public PacketDelayer() {
        super("PacketDelayer", "Delays some packets", 0, Category.EXPLOIT, Mode.NONE);
    }

    @Override
    public void onPreMotion(PreMotionEvent e) {
    }

    @Override
    public void onDisable() {
        for (Packet<NetHandlerPlayServer> packet : packets) {
            mc.getNetHandler().getNetworkManager().sendPacketWithoutEvent(packet);
        }
        packets.clear();
    }

    @Override
    public void onUpdate(UpdateEvent e) {
        if (mc.thePlayer.ticksExisted % 2 == 0) {
            for (Packet<NetHandlerPlayServer> packet : packets) {
                mc.getNetHandler().getNetworkManager().sendPacketWithoutEvent(packet);
            }

            System.out.println("Sent Packets" + packets.size());
            packets.clear();
        }
    }

    @Override
    public void onPacketSent(PacketSentEvent e) {
        Packet p = e.getPacket();

        if (!(p instanceof C00Handshake) && !(p instanceof C00PacketLoginStart) && !(p instanceof C00PacketServerQuery) && !(p instanceof C00PacketLoginStart)) {
            packets.add(p);
            e.setCancelled(true);
        }
    }
}
